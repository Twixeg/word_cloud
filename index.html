<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
  <title>–û–±–ª–∞–∫–æ —Å–ª–æ–≤</title>

  <!-- –ü–æ–¥–∫–ª—é—á–∞–µ–º Google Font: Open Sans -->
  <link href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@600;700&display=swap" rel="stylesheet" />

  <!-- D3.js –∏ d3-cloud -->
  <script src="https://d3js.org/d3.v7.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/d3-cloud@1.2.5/build/d3.layout.cloud.min.js"></script>

  <style>
    /* –°–±—Ä–æ—Å –∏ –±–∞–∑–æ–≤—ã–µ —Å—Ç–∏–ª–∏ */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    html, body {
      width: 100%;
      height: 100%;
      overflow: hidden;
      font-family: 'Open Sans', Arial, sans-serif;
      background: linear-gradient(135deg, #1a2a6c, #b21f1f, #fdbb2d);
      color: white;
    }

    #container {
      position: relative;
      width: 100vw;
      height: 100vh;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      text-align: center;
      padding: 20px;
    }

    h1 {
      font-size: clamp(1.8rem, 4vw, 3.5rem);
      font-weight: 700;
      margin-bottom: 10px;
      text-shadow: 0 2px 8px rgba(0,0,0,0.4);
      letter-spacing: -0.5px;
    }

    p.lead {
      font-size: clamp(1rem, 2.5vw, 1.4rem);
      max-width: 80%;
      margin-bottom: 20px;
      opacity: 0.9;
      text-shadow: 0 1px 4px rgba(0,0,0,0.5);
    }

    .form-link {
      display: inline-block;
      padding: 12px 28px;
      background: #ff6b35;
      color: white;
      text-decoration: none;
      border-radius: 50px;
      font-weight: 600;
      font-size: clamp(1rem, 2.5vw, 1.2rem);
      box-shadow: 0 4px 15px rgba(0,0,0,0.3);
      transition: all 0.3s ease;
    }

    .form-link:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(0,0,0,0.4);
    }

    button#refresh {
      margin-top: 15px;
      padding: 10px 20px;
      font-size: clamp(0.9rem, 2vw, 1.1rem);
      background-color: #4CAF50;
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      box-shadow: 0 3px 10px rgba(0,0,0,0.2);
      transition: background 0.3s;
    }

    button#refresh:hover {
      background-color: #45a049;
    }

    .loading {
      font-style: italic;
      margin-top: 10px;
      font-size: clamp(0.9rem, 2vw, 1.1rem);
      color: #e0f7fa;
      text-shadow: 0 1px 3px rgba(0,0,0,0.4);
    }

    svg {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      z-index: 0;
    }

    g {
      pointer-events: none;
    }

    text {
      font-family: 'Open Sans', Impact, sans-serif;
      font-weight: 700;
      fill: white;
      stroke: rgba(255, 255, 255, 0.2);
      stroke-width: 1;
      text-shadow: 1px 1px 3px rgba(0,0,0,0.6);
      transition: opacity 0.6s ease;
    }

    .overlay {
      position: relative;
      z-index: 1;
      pointer-events: auto;
    }
  </style>
</head>
<body>
  <svg id="wordcloud-svg"></svg>

  <div id="container">
    <div class="overlay">
      <h1>‚òÅÔ∏è –û–±–ª–∞–∫–æ —Å–ª–æ–≤ –∏–∑ –≤–∞—à–∏—Ö –æ—Ç–≤–µ—Ç–æ–≤</h1>
      <p class="lead">–ü—Ä–æ–π–¥–∏—Ç–µ —Ñ–æ—Ä–º—É ‚Äî –≤–∞—à–µ —Å–ª–æ–≤–æ —Å—Ç–∞–Ω–µ—Ç —á–∞—Å—Ç—å—é –æ–±—â–µ–≥–æ –æ–±–ª–∞–∫–∞!</p>
      <a href="https://docs.google.com/forms/d/e/1FAIpQLSc6SUsLHNuJ6gSkoaaojPnDuYbZMnftZwYp_livh25zJcAn8A/viewform?usp=header" target="_blank" class="form-link">–ü—Ä–æ–π—Ç–∏ —Ñ–æ—Ä–º—É</a>
      <button id="refresh">üîÑ –û–±–Ω–æ–≤–∏—Ç—å</button>
      <p class="loading" id="status">–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...</p>
    </div>
  </div>

  <script>
    // üîÅ –ó–∞–º–µ–Ω–∏—Ç–µ –Ω–∞ –≤–∞—à URL –∏–∑ Google Apps Script
    const GAS_JSONP_URL = "https://script.google.com/macros/s/AKfycbyLQ2achxsI5EL8HXtFJGUlB0yeQeaSCGcgu6OD74eMFVGYUpuUard90yRey6I15BYX/exec";

    const statusText = document.getElementById("status");
    const svg = d3.select("#wordcloud-svg");
    let width = window.innerWidth;
    let height = window.innerHeight;

    // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ä–∞–∑–º–µ—Ä SVG
    svg.attr("width", width).attr("height", height);
    const g = svg.append("g");

    // –¶–≤–µ—Ç–æ–≤–∞—è —à–∫–∞–ª–∞
    const colorScale = d3.scaleSequential(d3.interpolateRainbow)
      .domain([20, 100]);

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Ä–∞–∑–º–µ—Ä–∞ –æ–∫–Ω–∞
    function resize() {
      width = window.innerWidth;
      height = window.innerHeight;
      svg.attr("width", width).attr("height", height);
      if (currentWords) generateWordCloud(currentWords); // –ø–µ—Ä–µ—Ä–∏—Å–æ–≤–∞—Ç—å
    }

    window.addEventListener("resize", resize);

    // –•—Ä–∞–Ω–∏–º —Ç–µ–∫—É—â–∏–µ —Å–ª–æ–≤–∞ –¥–ª—è –ø–µ—Ä–µ—Ä–∏—Å–æ–≤–∫–∏
    let currentWords = null;

    // –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö
    document.getElementById("refresh").addEventListener("click", loadFromGoogleSheets);
    loadFromGoogleSheets(); // –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ

    function loadFromGoogleSheets() {
      statusText.textContent = "–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...";
      g.selectAll("*").remove();
      const oldScript = document.getElementById("jsonp-script");
      if (oldScript) oldScript.remove();

      const script = document.createElement("script");
      script.id = "jsonp-script";
      script.src = `${GAS_JSONP_URL}?callback=handleData`;
      script.onerror = () => {
        statusText.textContent = "–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö.";
      };
      document.body.appendChild(script);
    }

    function handleData(data) {
      const script = document.getElementById("jsonp-script");
      if (script) script.remove();

      if (!data || data.length === 0) {
        statusText.textContent = "–ü–æ–∫–∞ –Ω–µ—Ç –æ—Ç–≤–µ—Ç–æ–≤. –ë—É–¥—å—Ç–µ –ø–µ—Ä–≤—ã–º!";
        return;
      }

      if (data.error) {
        console.error("–û—à–∏–±–∫–∞:", data.message);
        statusText.textContent = "–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ.";
        return;
      }

      try {
        const keys = Object.keys(data[0] || {});
        const textColumn = keys.length > 1 ? keys[keys.length - 1] : keys[0];
        const allText = data.map(row => row[textColumn] || "").join(" ");

        const words = extractWords(allText);
        if (words.length === 0) {
          statusText.textContent = "–ù–µ—Ç –ø–æ–¥—Ö–æ–¥—è—â–∏—Ö —Å–ª–æ–≤.";
          return;
        }

        currentWords = words;
        generateWordCloud(words);
        statusText.textContent = `–ü–æ–∫–∞–∑–∞–Ω–æ ${Math.min(words.length, 100)} —Å–ª–æ–≤.`;
      } catch (err) {
        console.error("–û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏:", err);
        statusText.textContent = "–û—à–∏–±–∫–∞ –∞–Ω–∞–ª–∏–∑–∞ —Ç–µ–∫—Å—Ç–∞.";
      }
    }

    function extractWords(text) {
      const cleanText = text
        .toLowerCase()
        .replace(/[^\w\s–∞-—è—ë-]/gi, ' ')
        .replace(/\s+/g, ' ')
        .trim();

      const stopWords = new Set([
        '–∏', '–≤', '–Ω–∞', '—Å', '–∫', '—É', '–ø–æ', '–Ω–æ', '–∞', '—è', '–º—ã', '–≤—ã', '–æ–Ω', '–æ–Ω–∞', '–æ–Ω–∏',
        '—ç—Ç–æ', '—Ç–æ—Ç', '—Ç–∞–∫', '–∫–∞–∫', '–∂–µ', '–ª–∏', '–±—ã', '—á—Ç–æ', '–∫–æ—Ç–æ—Ä—ã–π', '–µ—Å–ª–∏', '–∏–ª–∏'
      ]);

      const freq = {};
      cleanText.split(/\s+/)
        .filter(w => w.length > 2 && !stopWords.has(w))
        .forEach(word => {
          freq[word] = (freq[word] || 0) + 1;
        });

      const maxFreq = Math.max(...Object.values(freq));
      const scale = d3.scaleLinear()
        .domain([1, maxFreq])
        .range([25, 100]); // –æ—Ç 25px –¥–æ 100px

      return Object.entries(freq)
        .map(([text, count]) => ({
          text: text.charAt(0).toUpperCase() + text.slice(1), // –ü–µ—Ä–≤–∞—è –±—É–∫–≤–∞ ‚Äî –∑–∞–≥–ª–∞–≤–Ω–∞—è
          size: scale(count),
          frequency: count
        }))
        .sort((a, b) => b.size - a.size)
        .slice(0, 100);
    }

    function generateWordCloud(words) {
      g.selectAll("*").remove();

      d3.layout.cloud()
        .size([width, height])
        .words(words)
        .padding(3)
        .rotate(() => 0)
        .font("'Open Sans', Impact")
        .fontSize(d => d.size)
        .on("end", draw)
        .start();

      function draw(words) {
        const texts = g.selectAll("text")
          .data(words)
          .enter().append("text")
          .style("font-size", d => d.size + "px")
          .style("fill", d => colorScale(d.size))
          .style("stroke", "rgba(255,255,255,0.2)")
          .style("stroke-width", 1)
          .attr("text-anchor", "middle")
          .attr("transform", d => `translate(${d.x},${d.y})`)
          .text(d => d.text.toUpperCase()) // üöÄ –í—Å–µ —Å–ª–æ–≤–∞ ‚Äî –±–æ–ª—å—à–∏–º–∏ –±—É–∫–≤–∞–º–∏!
          .style("opacity", 0)
          .transition()
          .duration(800)
          .style("opacity", 1);

        // –ü–æ–¥—Å–∫–∞–∑–∫–∞ –ø—Ä–∏ –Ω–∞–≤–µ–¥–µ–Ω–∏–∏
        texts.append("title")
          .text(d => `"${d.text}" ‚Äî –≤—Å—Ç—Ä–µ—á–∞–µ—Ç—Å—è ${d.frequency} —Ä–∞–∑`);
      }
    }
  </script>
</body>
</html>
