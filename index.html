<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>–û–±–ª–∞–∫–æ —Å–ª–æ–≤ –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</title>

  <!-- –ü–æ–¥–∫–ª—é—á–∞–µ–º D3.js –∏ d3-cloud -->
  <script src="https://d3js.org/d3.v7.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/d3-cloud@1.2.5/build/d3.layout.cloud.min.js"></script>

  <style>
    body {
      font-family: 'Arial', sans-serif;
      margin: 0;
      padding: 20px;
      background-color: #f9f9f9;
      color: #333;
      text-align: center;
    }
    h1 {
      color: #2c3e50;
    }
    p.lead {
      font-size: 1.1em;
      max-width: 600px;
      margin: 10px auto;
    }
    .form-link {
      display: inline-block;
      margin: 20px 0;
      padding: 12px 24px;
      background-color: #3498db;
      color: white;
      text-decoration: none;
      border-radius: 6px;
      font-weight: bold;
      font-size: 16px;
    }
    .form-link:hover {
      background-color: #2980b9;
    }
    button#refresh {
      padding: 10px 20px;
      font-size: 16px;
      background-color: #2ecc71;
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      margin-top: 10px;
    }
    button#refresh:hover {
      background-color: #27ae60;
    }
    svg {
      border: 1px solid #ddd;
      background: white;
      margin: 20px auto;
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }
    .loading {
      color: #7f8c8d;
      font-style: italic;
      margin: 10px 0;
    }
  </style>
</head>
<body>
  <h1>–û–±–ª–∞–∫–æ —Å–ª–æ–≤: —á—Ç–æ –≤—ã –¥—É–º–∞–µ—Ç–µ?</h1>
  <p class="lead">–ü—Ä–æ–π–¥–∏—Ç–µ –∫–æ—Ä–æ—Ç–∫—É—é —Ñ–æ—Ä–º—É ‚Äî –≤–∞—à –æ—Ç–≤–µ—Ç —Å—Ç–∞–Ω–µ—Ç —á–∞—Å—Ç—å—é –æ–±—â–µ–≥–æ –æ–±–ª–∞–∫–∞ —Å–ª–æ–≤!</p>
  <a href="https://docs.google.com/forms/d/e/YOUR_FORM_ID/viewform" target="_blank" class="form-link">–ü—Ä–æ–π—Ç–∏ —Ñ–æ—Ä–º—É</a>

  <button id="refresh">üîÑ –û–±–Ω–æ–≤–∏—Ç—å –æ–±–ª–∞–∫–æ</button>
  <p class="loading" id="status">–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...</p>

  <svg width="960" height="600"></svg>

  <script>
    // üîÅ –ó–∞–º–µ–Ω–∏—Ç–µ –Ω–∞ –≤–∞—à URL –∏–∑ Google Apps Script
    const GAS_JSONP_URL = "https://script.google.com/macros/s/AKfycbyLQ2achxsI5EL8HXtFJGUlB0yeQeaSCGcgu6OD74eMFVGYUpuUard90yRey6I15BYX/exec";

    // –≠–ª–µ–º–µ–Ω—Ç—ã DOM
    const statusText = document.getElementById("status");
    const svg = d3.select("svg");
    const g = svg.append("g").attr("transform", "translate(480,300)");

    // –ö–Ω–æ–ø–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
    document.getElementById("refresh").addEventListener("click", loadFromGoogleSheets);

    // –ó–∞–≥—Ä—É–∑–∏—Ç—å –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ
    loadFromGoogleSheets();

    // –§—É–Ω–∫—Ü–∏—è –∑–∞–≥—Ä—É–∑–∫–∏ —á–µ—Ä–µ–∑ JSONP
    function loadFromGoogleSheets() {
      // –û—á–∏—Å—Ç–∫–∞ –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è
      statusText.textContent = "–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...";
      g.selectAll("*").remove();

      // –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–π —Ç–µ–≥ script, –µ—Å–ª–∏ –µ—Å—Ç—å
      const oldScript = document.getElementById("jsonp-script");
      if (oldScript) oldScript.remove();

      // –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ –¥–æ–±–∞–≤–ª—è–µ–º —Å–∫—Ä–∏–ø—Ç
      const script = document.createElement("script");
      script.id = "jsonp-script";
      script.src = `${GAS_JSONP_URL}?callback=handleData`;
      script.onerror = () => {
        statusText.textContent = "–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.";
      };
      document.body.appendChild(script);
    }

    // –ö–æ–ª–±—ç–∫, –≤—ã–∑—ã–≤–∞–µ–º—ã–π –ø–æ—Å–ª–µ –ø–æ–ª—É—á–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö
    function handleData(data) {
      const script = document.getElementById("jsonp-script");
      if (script) script.remove(); // —É–¥–∞–ª—è–µ–º –ø–æ—Å–ª–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è

      if (!data || data.length === 0) {
        statusText.textContent = "–ü–æ–∫–∞ –Ω–µ—Ç –Ω–∏ –æ–¥–Ω–æ–≥–æ –æ—Ç–≤–µ—Ç–∞. –ü—Ä–æ–π–¥–∏—Ç–µ —Ñ–æ—Ä–º—É!";
        return;
      }

      if (data.error) {
        console.error("–û—à–∏–±–∫–∞ –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞:", data);
        statusText.textContent = "–û—à–∏–±–∫–∞: " + data.message;
        return;
      }

      try {
        // –ò–∑–≤–ª–µ–∫–∞–µ–º —Ç–µ–∫—Å—Ç –∏–∑ –∫–æ–ª–æ–Ω–∫–∏ (–ø–æ–¥—Å—Ç–∞–≤—å—Ç–µ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–µ –∏–º—è)
        // –û–±—ã—á–Ω–æ –ø–µ—Ä–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞ ‚Äî –≤—Ä–µ–º–µ–Ω–Ω–∞—è –º–µ—Ç–∫–∞, –≤—Ç–æ—Ä–∞—è ‚Äî –æ—Ç–≤–µ—Ç
        const firstRow = data[0];
        const keys = Object.keys(firstRow);
        const textColumn = keys[keys.length - 1]; // –ø–æ—Å–ª–µ–¥–Ω—è—è –∫–æ–ª–æ–Ω–∫–∞ ‚Äî —Å–∫–æ—Ä–µ–µ –≤—Å–µ–≥–æ –æ—Ç–≤–µ—Ç

        const allText = data.map(row => row[textColumn] || "").join(" ");

        const words = extractWords(allText);
        if (words.length === 0) {
          statusText.textContent = "–ù–µ—Ç –ø–æ–¥—Ö–æ–¥—è—â–∏—Ö —Å–ª–æ–≤ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è.";
          return;
        }

        generateWordCloud(words);
        statusText.textContent = `–ü–æ–∫–∞–∑–∞–Ω–æ ${Math.min(words.length, 100)} —Å–ª–æ–≤.`;
      } catch (err) {
        console.error("–û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –¥–∞–Ω–Ω—ã—Ö:", err);
        statusText.textContent = "–û—à–∏–±–∫–∞ –∞–Ω–∞–ª–∏–∑–∞ –¥–∞–Ω–Ω—ã—Ö.";
      }
    }

    // –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ –∏ –ø–æ–¥—Å—á—ë—Ç —á–∞—Å—Ç–æ—Ç—ã —Å–ª–æ–≤
    function extractWords(text) {
      const cleanText = text
        .toLowerCase()
        .replace(/[^\w\s–∞-—è—ë-]/gi, ' ') // –∑–∞–º–µ–Ω—è–µ–º –ø—É–Ω–∫—Ç—É–∞—Ü–∏—é –Ω–∞ –ø—Ä–æ–±–µ–ª—ã
        .replace(/\s+/g, ' ')
        .trim();

      const words = cleanText.split(/\s+/).filter(w => w.length > 2);

      // –°—Ç–æ–ø-—Å–ª–æ–≤–∞ (–º–æ–∂–Ω–æ —Ä–∞—Å—à–∏—Ä–∏—Ç—å)
      const stopWords = new Set([
        '–∏', '–≤', '–Ω–∞', '—Å', '–∫', '—É', '–ø–æ', '–Ω–æ', '–∞', '—è', '–º—ã', '–≤—ã', '–æ–Ω', '–æ–Ω–∞',
        '–æ–Ω–∏', '—ç—Ç–æ', '—Ç–æ—Ç', '—Ç–∞–∫', '–∫–∞–∫', '–∂–µ', '–ª–∏', '–±—ã', '—á—Ç–æ', '–∫–æ—Ç–æ—Ä—ã–π'
      ]);

      const freq = {};
      words.forEach(word => {
        if (!stopWords.has(word)) {
          freq[word] = (freq[word] || 0) + 1;
        }
      });

      // –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –≤ –º–∞—Å—Å–∏–≤ –∏ —Å–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ —á–∞—Å—Ç–æ—Ç–µ
      return Object.entries(freq)
        .map(([text, count]) => ({ text, size: Math.max(10, count * 10) }))
        .sort((a, b) => b.size - a.size)
        .slice(0, 100); // –º–∞–∫—Å–∏–º—É–º 100 —Å–ª–æ–≤
    }

    // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –æ–±–ª–∞–∫–∞ —Å–ª–æ–≤
    function generateWordCloud(words) {
      g.selectAll("*").remove(); // –æ—á–∏—Å—Ç–∏—Ç—å

      d3.layout.cloud()
        .size([960, 600])
        .words(words)
        .padding(3)
        .rotate(() => 0) // –≤—Å–µ —Å–ª–æ–≤–∞ –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–æ
        .font("Impact")
        .fontSize(d => d.size)
        .on("end", draw)
        .start();

      function draw(words) {
        g.selectAll("text")
          .data(words)
          .enter().append("text")
          .style("font-size", d => d.size + "px")
          .style("font-family", "Impact")
          .style("fill", () => d3.interpolateSinebow(Math.random()))
          .attr("text-anchor", "middle")
          .attr("transform", d => `translate(${d.x},${d.y})`)
          .text(d => d.text);
      }
    }
  </script>
</body>
</html>
