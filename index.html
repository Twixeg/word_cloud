<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>–û–±–ª–∞–∫–æ —Å–ª–æ–≤ ‚Äî —á—Ç–æ –≤—ã –¥—É–º–∞–µ—Ç–µ?</title>

  <!-- D3.js –∏ d3-cloud -->
  <script src="https://d3js.org/d3.v7.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/d3-cloud@1.2.5/build/d3.layout.cloud.min.js"></script>

  <style>
    body {
      margin: 0;
      padding: 0;
      font-family: 'Segoe UI', Arial, sans-serif;
      background: linear-gradient(135deg, #1e3c72, #2a5298);
      color: white;
      text-align: center;
      min-height: 100vh;
    }
    h1 {
      font-size: 2.5em;
      margin: 30px 0 10px;
      text-shadow: 0 2px 4px rgba(0,0,0,0.3);
    }
    p.lead {
      font-size: 1.2em;
      max-width: 600px;
      margin: 10px auto 20px;
      opacity: 0.9;
    }
    .form-link {
      display: inline-block;
      padding: 14px 28px;
      background: #ff6b6b;
      color: white;
      text-decoration: none;
      border-radius: 50px;
      font-weight: bold;
      font-size: 18px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.2);
      transition: transform 0.2s, box-shadow 0.2s;
    }
    .form-link:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 15px rgba(0,0,0,0.3);
    }
    button#refresh {
      padding: 12px 24px;
      font-size: 16px;
      background-color: #f39c12;
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      margin-top: 15px;
      box-shadow: 0 3px 8px rgba(0,0,0,0.2);
      transition: background 0.3s;
    }
    button#refresh:hover {
      background-color: #e67e22;
    }
    .loading {
      color: #ecf0f1;
      font-style: italic;
      margin: 20px 0;
      font-size: 1.1em;
    }
    svg {
      display: block;
      margin: 20px auto;
      width: 90%;
      max-width: 1000px;
      height: 600px;
      border-radius: 12px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.3);
      background: rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(10px);
    }
    text {
      transition: opacity 0.5s ease, transform 0.3s ease;
    }
  </style>
</head>
<body>
  <h1>‚òÅÔ∏è –û–±–ª–∞–∫–æ —Å–ª–æ–≤ –∏–∑ –≤–∞—à–∏—Ö –æ—Ç–≤–µ—Ç–æ–≤</h1>
  <p class="lead">–ü—Ä–æ–π–¥–∏—Ç–µ —Ñ–æ—Ä–º—É ‚Äî –≤–∞—à–µ —Å–ª–æ–≤–æ —Å—Ç–∞–Ω–µ—Ç —á–∞—Å—Ç—å—é –æ–±—â–µ–≥–æ –æ–±–ª–∞–∫–∞!</p>
  <a href="https://docs.google.com/forms/d/e/1FAIpQLSc6SUsLHNuJ6gSkoaaojPnDuYbZMnftZwYp_livh25zJcAn8A/viewform?usp=header" target="_blank" class="form-link">–ü—Ä–æ–π—Ç–∏ —Ñ–æ—Ä–º—É</a>
  <button id="refresh">üîÑ –û–±–Ω–æ–≤–∏—Ç—å –æ–±–ª–∞–∫–æ</button>
  <p class="loading" id="status">–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...</p>
  <svg width="960" height="600"></svg>

  <script>
    const GAS_JSONP_URL = "https://script.google.com/macros/s/AKfycbyLQ2achxsI5EL8HXtFJGUlB0yeQeaSCGcgu6OD74eMFVGYUpuUard90yRey6I15BYX/exec";
    const statusText = document.getElementById("status");
    const svg = d3.select("svg");
    const g = svg.append("g").attr("transform", "translate(480,300)");

    document.getElementById("refresh").addEventListener("click", loadFromGoogleSheets);

    // –ó–∞–≥—Ä—É–∑–∏—Ç—å –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ
    loadFromGoogleSheets();

    function loadFromGoogleSheets() {
      statusText.textContent = "–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...";
      g.selectAll("*").remove();
      const oldScript = document.getElementById("jsonp-script");
      if (oldScript) oldScript.remove();

      const script = document.createElement("script");
      script.id = "jsonp-script";
      script.src = `${GAS_JSONP_URL}?callback=handleData`;
      script.onerror = () => {
        statusText.textContent = "–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö.";
      };
      document.body.appendChild(script);
    }

    function handleData(data) {
      const script = document.getElementById("jsonp-script");
      if (script) script.remove();

      if (!data || data.length === 0) {
        statusText.textContent = "–ü–æ–∫–∞ –Ω–µ—Ç –æ—Ç–≤–µ—Ç–æ–≤. –ë—É–¥—å—Ç–µ –ø–µ—Ä–≤—ã–º!";
        return;
      }

      if (data.error) {
        console.error("–û—à–∏–±–∫–∞:", data.message);
        statusText.textContent = "–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ.";
        return;
      }

      try {
        const keys = Object.keys(data[0] || {});
        const textColumn = keys.length > 1 ? keys[keys.length - 1] : keys[0];

        const allText = data.map(row => row[textColumn] || "").join(" ");
        const words = extractWords(allText);

        if (words.length === 0) {
          statusText.textContent = "–ù–µ—Ç –ø–æ–¥—Ö–æ–¥—è—â–∏—Ö —Å–ª–æ–≤ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è.";
          return;
        }

        generateWordCloud(words);
        statusText.textContent = `–ü–æ–∫–∞–∑–∞–Ω–æ ${Math.min(words.length, 100)} —Å–ª–æ–≤.`;
      } catch (err) {
        console.error("–û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏:", err);
        statusText.textContent = "–û—à–∏–±–∫–∞ –∞–Ω–∞–ª–∏–∑–∞ —Ç–µ–∫—Å—Ç–∞.";
      }
    }

    function extractWords(text) {
      const cleanText = text
        .toLowerCase()
        .replace(/[^\w\s–∞-—è—ë-]/gi, ' ')
        .replace(/\s+/g, ' ')
        .trim();

      const stopWords = new Set([
        '–∏', '–≤', '–Ω–∞', '—Å', '–∫', '—É', '–ø–æ', '–Ω–æ', '–∞', '—è', '–º—ã', '–≤—ã', '–æ–Ω', '–æ–Ω–∞', '–æ–Ω–∏',
        '—ç—Ç–æ', '—Ç–æ—Ç', '—Ç–∞–∫', '–∫–∞–∫', '–∂–µ', '–ª–∏', '–±—ã', '—á—Ç–æ', '–∫–æ—Ç–æ—Ä—ã–π', '–µ—Å–ª–∏', '–∏–ª–∏'
      ]);

      const freq = {};
      cleanText.split(/\s+/)
        .filter(w => w.length > 2 && !stopWords.has(w))
        .forEach(word => {
          freq[word] = (freq[word] || 0) + 1;
        });

      // üî• –ì–ª–∞–≤–Ω–æ–µ: —Ä–∞–∑–º–µ—Ä –ø—Ä—è–º–æ –ø—Ä–æ–ø–æ—Ä—Ü–∏–æ–Ω–∞–ª–µ–Ω —á–∞—Å—Ç–æ—Ç–µ!
      const maxSize = 100; // –º–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π –≤–æ–∑–º–æ–∂–Ω—ã–π —Ä–∞–∑–º–µ—Ä
      const maxFreq = Math.max(...Object.values(freq));
      const scale = d3.scaleLinear()
        .domain([1, maxFreq])
        .range([20, maxSize]); // –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–π —Ä–∞–∑–º–µ—Ä ‚Äî 20px

      return Object.entries(freq)
        .map(([text, count]) => ({
          text,
          size: scale(count), // ‚úÖ –ü—Ä—è–º–∞—è –ø—Ä–æ–ø–æ—Ä—Ü–∏—è!
          frequency: count
        }))
        .sort((a, b) => b.size - a.size)
        .slice(0, 100);
    }

    function generateWordCloud(words) {
      g.selectAll("*").remove();

      // –¶–≤–µ—Ç–æ–≤–∞—è —à–∫–∞–ª–∞ –ø–æ —Ä–∞–∑–º–µ—Ä—É
      const colorScale = d3.scaleSequential(d3.interpolateViridis)
        .domain(d3.extent(words, d => d.size));

      d3.layout.cloud()
        .size([960, 600])
        .words(words)
        .padding(2)
        .rotate(() => 0)
        .font("Impact")
        .fontSize(d => d.size)
        .on("end", draw)
        .start();

      function draw(words) {
        const texts = g.selectAll("text")
          .data(words)
          .enter().append("text")
          .style("font-size", d => d.size + "px")
          .style("font-family", "Impact")
          .style("fill", d => colorScale(d.size))
          .style("text-shadow", "2px 2px 4px rgba(0,0,0,0.5)")
          .attr("text-anchor", "middle")
          .attr("transform", d => `translate(${d.x},${d.y})`)
          .text(d => d.text)
          .style("opacity", 0)
          .transition()
          .duration(800)
          .style("opacity", 1);

        // –ü–æ–¥—Å–∫–∞–∑–∫–∞ –ø—Ä–∏ –Ω–∞–≤–µ–¥–µ–Ω–∏–∏
        texts.append("title")
          .text(d => `"${d.text}" ‚Äî –≤—Å—Ç—Ä–µ—á–∞–µ—Ç—Å—è ${d.frequency} —Ä–∞–∑`);
      }
    }
  </script>
</body>
</html>
