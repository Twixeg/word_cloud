<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
    <title>–û–±–ª–∞–∫–æ —Å–ª–æ–≤</title>

    <link href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@600;700&display=swap" rel="stylesheet" />

    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/d3-cloud@1.2.5/build/d3.layout.cloud.min.js"></script>

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        /* –ê–Ω–∏–º–∏—Ä—É–µ–º—ã–π —Ñ–æ–Ω */
        .background {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
            background: linear-gradient(135deg, #1a2a6c, #b21f1f, #fdbb2d);
            background-size: 300% 300%;
            animation: gradientShift 15s ease infinite alternate, gradientFlow 25s ease-in-out infinite;
        }

        @keyframes gradientShift {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        @keyframes gradientFlow {
            0% { background-size: 300% 300%; }
            50% { background-size: 200% 200%; }
            100% { background-size: 300% 300%; }
        }

        body {
            width: 100vw;
            height: 100vh;
            overflow: hidden;
            font-family: 'Open Sans', Arial, sans-serif;
            color: white;
            background: transparent;
            display: flex;
            flex-direction: column;
        }

        #container {
            width: 100%;
            padding: 20px;
            text-align: center;
            z-index: 10;
            position: relative;
        }

        h1 {
            font-size: clamp(2rem, 4vw, 3.5rem);
            font-weight: 700;
            margin-bottom: 10px;
            text-shadow: 0 2px 8px rgba(0,0,0,0.4);
            letter-spacing: -0.5px;
        }

        p.lead {
            font-size: clamp(1rem, 2.5vw, 1.4rem);
            max-width: 80%;
            margin: 0 auto 20px;
            opacity: 0.9;
            text-shadow: 0 1px 4px rgba(0,0,0,0.5);
        }

        .form-link {
            display: inline-block;
            padding: 12px 28px;
            background: #ff6b35;
            color: white;
            text-decoration: none;
            border-radius: 50px;
            font-weight: 600;
            font-size: clamp(1rem, 2.5vw, 1.2rem);
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            transition: all 0.3s ease;
        }

        .form-link:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.4);
        }

        button#refresh {
            margin-top: 15px;
            padding: 10px 20px;
            font-size: clamp(0.9rem, 2vw, 1.1rem);
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            box-shadow: 0 3px 10px rgba(0,0,0,0.2);
            transition: background 0.3s;
        }

        button#refresh:hover {
            background-color: #45a049;
        }

        .loading {
            font-style: italic;
            margin-top: 10px;
            font-size: clamp(0.9rem, 2vw, 1.1rem);
            color: #e0f7fa;
            text-shadow: 0 1px 3px rgba(0,0,0,0.4);
        }
        
        #canvas-wrapper {
            flex-grow: 1;
            position: relative;
        }
        
        #wordcloud-canvas {
            position: absolute;
            top: 0;
            left: 0;
        }
    </style>
</head>
<body>
    <div class="background"></div>

    <div id="container">
        <h1>‚òÅÔ∏è –û–±–ª–∞–∫–æ —Å–ª–æ–≤ –∏–∑ –≤–∞—à–∏—Ö –æ—Ç–≤–µ—Ç–æ–≤</h1>
        <p class="lead">–ü—Ä–æ–π–¥–∏—Ç–µ —Ñ–æ—Ä–º—É ‚Äî –≤–∞—à–µ —Å–ª–æ–≤–æ —Å—Ç–∞–Ω–µ—Ç —á–∞—Å—Ç—å—é –æ–±—â–µ–≥–æ –æ–±–ª–∞–∫–∞!</p>
        <a href="https://docs.google.com/forms/d/e/YOUR_FORM_ID/viewform" target="_blank" class="form-link">–ü—Ä–æ–π—Ç–∏ —Ñ–æ—Ä–º—É</a>
        <button id="refresh">üîÑ –û–±–Ω–æ–≤–∏—Ç—å</button>
        <p class="loading" id="status">–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...</p>
    </div>

    <div id="canvas-wrapper">
        <canvas id="wordcloud-canvas"></canvas>
    </div>

    <script>
        const GAS_JSONP_URL = "https://script.google.com/macros/s/AKfycbyLQ2achxsI5EL8HXtFJGUlB0yeQeaSCGcgu6OD74eMFVGYUpuUard90yRey6I15BYX/exec";
        const statusText = document.getElementById("status");
        const canvas = document.getElementById("wordcloud-canvas");
        const ctx = canvas.getContext("2d");
        const canvasWrapper = document.getElementById("canvas-wrapper");
        
        let currentWords = null;
        let width, height;

        // –ü–∞–ª–∏—Ç—Ä–∞ —Ü–≤–µ—Ç–æ–≤ –¥–ª—è —Å–ª–æ–≤
        const wordColors = [
            '#ff6b6b', '#ff9f43', '#feca57', '#ffeaa7', '#55efc4',
            '#81ecec', '#74b9ff', '#a29bfe', '#dfe6e9', '#00cec9'
        ];
        
        const floatRange = 10;
        const animationDuration = 1500;
        const shadowBlur = 8;
        const shadowColor = 'rgba(0, 0, 0, 0.4)';

        function resizeCanvas() {
            width = canvasWrapper.offsetWidth;
            height = canvasWrapper.offsetHeight;
            canvas.width = width;
            canvas.height = height;
            if (currentWords) generateWordCloud(currentWords);
        }

        window.addEventListener("resize", resizeCanvas);

        document.getElementById("refresh").addEventListener("click", loadFromGoogleSheets);
        loadFromGoogleSheets();

        function loadFromGoogleSheets() {
            statusText.textContent = "–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...";
            ctx.clearRect(0, 0, width, height);
            const oldScript = document.getElementById("jsonp-script");
            if (oldScript) oldScript.remove();

            const script = document.createElement("script");
            script.id = "jsonp-script";
            script.src = `${GAS_JSONP_URL}?callback=handleData`;
            script.onerror = () => {
                statusText.textContent = "–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö.";
            };
            document.body.appendChild(script);
        }

        function handleData(data) {
            const script = document.getElementById("jsonp-script");
            if (script) script.remove();

            if (!data || data.length === 0) {
                statusText.textContent = "–ü–æ–∫–∞ –Ω–µ—Ç –æ—Ç–≤–µ—Ç–æ–≤. –ë—É–¥—å—Ç–µ –ø–µ—Ä–≤—ã–º!";
                return;
            }

            if (data.error) {
                console.error("–û—à–∏–±–∫–∞:", data.message);
                statusText.textContent = "–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ.";
                return;
            }

            try {
                const keys = Object.keys(data[0] || {});
                const textColumn = keys.length > 1 ? keys[keys.length - 1] : keys[0];
                const allText = data.map(row => row[textColumn] || "").join(" ");

                const words = extractWords(allText);
                if (words.length === 0) {
                    statusText.textContent = "–ù–µ—Ç –ø–æ–¥—Ö–æ–¥—è—â–∏—Ö —Å–ª–æ–≤.";
                    return;
                }

                currentWords = words;
                resizeCanvas();
                statusText.textContent = `–ü–æ–∫–∞–∑–∞–Ω–æ ${Math.min(words.length, 100)} —Å–ª–æ–≤.`;
            } catch (err) {
                console.error("–û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏:", err);
                statusText.textContent = "–û—à–∏–±–∫–∞ –∞–Ω–∞–ª–∏–∑–∞ —Ç–µ–∫—Å—Ç–∞.";
            }
        }

        function extractWords(text) {
            const cleanText = text
                .toLowerCase()
                .replace(/[^\w\s–∞-—è—ë-]/gi, ' ')
                .replace(/\s+/g, ' ')
                .trim();

            const stopWords = new Set([
                '–∏', '–≤', '–Ω–∞', '—Å', '–∫', '—É', '–ø–æ', '–Ω–æ', '–∞', '—è', '–º—ã', '–≤—ã', '–æ–Ω', '–æ–Ω–∞', '–æ–Ω–∏',
                '—ç—Ç–æ', '—Ç–æ—Ç', '—Ç–∞–∫', '–∫–∞–∫', '–∂–µ', '–ª–∏', '–±—ã', '—á—Ç–æ', '–∫–æ—Ç–æ—Ä—ã–π', '–µ—Å–ª–∏', '–∏–ª–∏'
            ]);

            const freq = {};
            cleanText.split(/\s+/)
                .filter(w => w.length > 2 && !stopWords.has(w))
                .forEach(word => {
                    freq[word] = (freq[word] || 0) + 1;
                });

            const sortedWords = Object.entries(freq)
                .map(([text, count]) => ({ text, count }))
                .sort((a, b) => b.count - a.count);

            const maxFreq = sortedWords[0] ? sortedWords[0].count : 1;
            
            const top3Words = sortedWords.slice(0, 3).map(d => d.text);
            
            const scale = d3.scaleLinear()
                .domain([1, maxFreq])
                .range([20, 100]);

            return Object.entries(freq)
                .map(([text, count]) => ({
                    text: text.charAt(0).toUpperCase() + text.slice(1),
                    size: top3Words.includes(text) ? scale(count) * 1.5 : scale(count),
                    frequency: count
                }))
                .sort((a, b) => b.size - a.size)
                .slice(0, 100);
        }

        const animatedWords = [];
        let animationFrameId = null;
        let animationStartTime = 0;

        function generateWordCloud(words) {
            animatedWords.length = 0;

            d3.layout.cloud()
                .size([width, height])
                .words(words)
                .padding(3)
                .rotate(() => 0)
                .font("'Open Sans', Impact")
                .fontSize(d => d.size)
                .on("end", (newWords) => {
                    newWords.forEach(word => {
                        word.initialX = word.x;
                        word.initialY = word.y;
                        word.animationOffset = Math.random() * 2 * Math.PI;
                        word.color = wordColors[Math.floor(Math.random() * wordColors.length)];
                    });
                    animatedWords.push(...newWords);
                    startAnimation(true);
                })
                .start();
        }

        function startAnimation(isInitial = false) {
            if (animationFrameId) {
                cancelAnimationFrame(animationFrameId);
            }
            if (isInitial) {
                animationStartTime = performance.now();
            }
            animate();
        }

        function animate(now) {
            ctx.clearRect(0, 0, width, height);
            ctx.save();
            ctx.translate(width / 2, height / 2);

            const timeFactor = now / 2000;
            const elapsedTime = now - animationStartTime;
            const progress = Math.min(elapsedTime / animationDuration, 1);
            
            const scaleFactor = d3.easeCubicInOut(progress);
            
            animatedWords.forEach((word) => {
                const t = timeFactor + word.animationOffset;
                const xOffset = d3.easeCubicInOut(Math.sin(t)) * floatRange;
                const yOffset = d3.easeCubicInOut(Math.cos(t)) * floatRange;

                const currentSize = word.size * scaleFactor;
                
                // –≠—Ñ—Ñ–µ–∫—Ç —Ç–µ–Ω–∏ –¥–ª—è —Ç–µ–∫—Å—Ç–∞
                ctx.shadowBlur = shadowBlur;
                ctx.shadowColor = shadowColor;
                
                ctx.fillStyle = word.color; // –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —Å–ª—É—á–∞–π–Ω–æ–≥–æ —Ü–≤–µ—Ç–∞
                ctx.font = `${currentSize}px 'Open Sans', Impact`;
                ctx.textAlign = "center";
                ctx.textBaseline = "middle";
                
                ctx.save();
                ctx.translate(word.initialX + xOffset, word.initialY + yOffset);
                ctx.rotate(word.rotate * Math.PI / 180);

                // –ë–µ–ª—ã–π –∫–æ–Ω—Ç—É—Ä
                ctx.strokeStyle = "rgba(255, 255, 255, 0.8)";
                ctx.lineWidth = 1;
                ctx.strokeText(word.text.toUpperCase(), 0, 0);

                // –ó–∞–ª–∏–≤–∫–∞ —Ç–µ–∫—Å—Ç–∞
                ctx.fillText(word.text.toUpperCase(), 0, 0);
                
                ctx.restore();
            });
            
            ctx.restore();
            animationFrameId = requestAnimationFrame(animate);
        }
    </script>
</body>
</html>
